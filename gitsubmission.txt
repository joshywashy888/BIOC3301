#!/bin/bash
#SBATCH -t 1:00:00
#SBATCH -n 24
#SBATCH -p short
#SBATCH --reservation=cbmucl
#Load modules to run python
module load eb
module load Miniconda2
source deactivate
# loading virtualenv
echo "loading virtualenv"
source activate qiime1
# setting temporary directory
export TMPDIR=~/qiime_tmp

#joining ends
join_paired_ends.py 
-f Read1.fastq.gz 
-r Read2.fastq.gz 
-o joined_ends

#splitting the libraries
split_libraries_fastq.py \ 
-m map.tsv \
-i read1.fastq.gz \
-b barcode.fastq.gz \
-o ./slout `#pick any name or path here` \
-q 19
--rev_comp_barcode \
--rev_comp_mapping_barcodes

# picking OTUs
echo "Picking OTUs with closed reference"
time pick_closed_reference_otus.py -i slout/seqs.fna -o otus -a -O 16

core_diversity_analyses.py \
--recover_from_failure \
-o cdout \
-i otus/otu_table.biom \
-m map.tsv \
-t otus/97_otus.tree \
-e 710 

source deactivate
#split_libraries_fastq.py -m map_incomplete.tsv -i joined_ends/fastqjoin.join.fastq -b #joined_ends/fastqjoin.join_barcodes.fastq -o ./slout -q 19 --rev_comp_barcode --#rev_comp_mapping_barcodes

core_diversity_analyses.py \ --recover_from_failure -o cdout3 -i otus3/otu_table_mc2_w_tax.biom -m map_incomplete.tsv -t otus3/rep_set.tre -e 1898 -a

compare_taxa_summaries.py -i summarize_taxa_2/otu_table_mc2_w_tax_no_pynast_failures_L2.txt,summarize_taxa_3/otu_table_mc2_w_tax_no_pynast_failures_L2.txt -m paired -o taxa_comparison_low -c spearman -t low

plot_taxa_summary.py -i taxa_comparison_detailed_2/otu_table_mc2_w_tax_no_pynast_failures_L2_sorted_and_filled_0.txt -l phylum -c pie,bar,area -o phylum_charts-spearman

summarize_taxa.py -i otus3/otu_table_mc2_w_tax_no_pynast_failures.biom -o ./summarize_taxa_3_top_90 -L 2 -u 0.01

echo "splitting"
split_libraries_fastq.py -m map_incomplete.tsv -i joined_ends/fastqjoin.join.fastq -b joined_ends/fastqjoin.join_barcodes.fastq -o ./slout3 -q 19 --rev_comp_barcode --rev_comp_mapping_barcodes

echo "Counting sequences"
time count_seqs.py -i slout3/seqs.fna

echo "Picking OTUs with open reference using silva"
time pick_open_reference_otus.py -i slout3/seqs.fna -o otus3 -a -O 24 -s 0.1 -p silva-123-params.txt -r ~/2018_03_smb/SILVA_132_QIIME_release/rep_set/rep_set_16S_only/97/silva_132_97_16S.fna

compute_core_microbiome.py -i otus2/otu_table_mc2_w_tax_no_pynast_failures.biom -o otus2/otu_table_core_fast --mapping_fp map_incomplete.tsv --valid_states --min_fraction_for_core :0.1

compare_alpha_diversity.py -i cdout4/arare_max770/alpha_div_collated/PD_whole_tree.txt -d 100 -m map_incomplete_L2.tsv.txt -c SampleID -o alphagreen